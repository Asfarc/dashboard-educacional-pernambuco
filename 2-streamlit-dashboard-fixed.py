import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np
import os
from pathlib import Path

# -------------------------------
# ConfiguraÃ§Ã£o Inicial da PÃ¡gina
# -------------------------------
st.set_page_config(
    page_title="Dashboard PNE",
    page_icon="ðŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# -------------------------------
# FunÃ§Ãµes Auxiliares
# -------------------------------

def formatar_numero(numero):
    """
    Formata nÃºmeros grandes adicionando separadores de milhar.
    Se o nÃºmero for NaN ou '-', retorna '-'.
    """
    if pd.isna(numero) or numero == "-":
        return "-"
    return f"{int(numero):,}".replace(",", ".")

def carregar_dados():
    """
    Carrega os dados das planilhas no formato Parquet.
    - LÃª os arquivos: escolas.parquet, estado.parquet e municipio.parquet.
    - Converte colunas que comeÃ§am com 'NÃºmero de' para tipo numÃ©rico.
    Em caso de erro, exibe uma mensagem e interrompe a execuÃ§Ã£o.
    """
    try:
        # Carregar os trÃªs arquivos Parquet
        escolas_df = pd.read_parquet("escolas.parquet")
        estado_df = pd.read_parquet("estado.parquet")
        municipio_df = pd.read_parquet("municipio.parquet")
        
        # Converter colunas numÃ©ricas para o tipo correto
        for df in [escolas_df, estado_df, municipio_df]:
            for col in df.columns:
                if col.startswith("NÃºmero de"):
                    df[col] = pd.to_numeric(df[col], errors='coerce')
        
        return escolas_df, estado_df, municipio_df
    
    except Exception as e:
        st.error(f"Erro ao carregar os dados: {e}")
        st.info("Verifique se os arquivos Parquet estÃ£o disponÃ­veis no repositÃ³rio.")
        st.stop()
        
# -------------------------------
# Carregamento de Dados
# -------------------------------
try:
    escolas_df, estado_df, municipio_df = carregar_dados()
except Exception as e:
    st.error(f"Erro ao carregar os dados: {e}")
    st.stop()

# ======================================
# CONFIGURAÃ‡ÃƒO DOS DADOS EDUCACIONAIS
# ======================================

def criar_mapeamento_colunas(df):
    """
    Cria um dicionÃ¡rio que mapeia as etapas de ensino para os nomes das colunas.
    Esse mapeamento inclui a coluna principal, subetapas e sÃ©ries, facilitando a seleÃ§Ã£o
    dos dados conforme os filtros do usuÃ¡rio.
    
    ParÃ¢metros:
    df (DataFrame): DataFrame a ser usado como referÃªncia para verificar colunas existentes
    """
    # Cria um dicionÃ¡rio de correspondÃªncia insensÃ­vel a maiÃºsculas/minÃºsculas
    colunas_map = {col.lower().strip(): col for col in df.columns}
    
    mapeamento = {
        "EducaÃ§Ã£o Infantil": {
            "coluna_principal": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Infantil",
            "subetapas": {
                "Creche": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Infantil - Creche",
                "PrÃ©-Escola": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Infantil - PrÃ©-Escola"
            },
            "series": {}
        },
        "Ensino Fundamental": {
            "coluna_principal": "NÃºmero de MatrÃ­culas do Ensino Fundamental",
            "subetapas": {
                "Anos Iniciais": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais",
                "Anos Finais": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Finais"
            },
            "series": {
                "Anos Iniciais": {
                    "1Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais - 1Âº Ano",
                    "2Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais - 2Âº Ano",
                    "3Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais - 3Âº Ano",
                    "4Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais - 4Âº Ano",
                    "5Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Iniciais - 5Âº Ano"
                },
                "Anos Finais": {
                    "6Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Finais - 6Âº Ano",
                    "7Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Finais - 7Âº Ano",
                    "8Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Finais - 8Âº Ano",
                    "9Âº Ano": "NÃºmero de MatrÃ­culas do Ensino Fundamental - Anos Finais - 9Âº Ano"
                }
            }
        },
        "Ensino MÃ©dio": {
            "coluna_principal": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio",
            "subetapas": {
                "PropedÃªutico": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico",
                "Curso TÃ©cnico Integrado": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional",
                "Normal/MagistÃ©rio": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Modalidade Normal/MagistÃ©rio"
            },
            "series": {
                "PropedÃªutico": {
                    "1Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico - 1Âº ano/1Âª SÃ©rie",
                    "2Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico - 2Âº ano/2Âª SÃ©rie",
                    "3Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico - 3Âº ano/3Âª SÃ©rie",
                    "4Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico - 4Âº ano/4Âª SÃ©rie",
                    "NÃ£o Seriado": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - PropedÃªutico - NÃ£o Seriado"
                },
                "Curso TÃ©cnico Integrado": {
                    "1Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional - 1Âº ano/1Âª SÃ©rie",
                    "2Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional - 2Âº ano/2Âª SÃ©rie",
                    "3Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional - 3Âº ano/3Âª SÃ©rie",
                    "4Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional - 4Âº ano/4Âª SÃ©rie",
                    "NÃ£o Seriado": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Curso TÃ©cnico Integrado Ã  EducaÃ§Ã£o Profissional - NÃ£o Seriado"
                },
                "Normal/MagistÃ©rio": {
                    "1Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Modalidade Normal/MagistÃ©rio - 1Âº ano/1Âª SÃ©rie",
                    "2Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Modalidade Normal/MagistÃ©rio - 2Âº ano/2Âª SÃ©rie",
                    "3Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Modalidade Normal/MagistÃ©rio - 3Âº ano/3Âª SÃ©rie",
                    "4Âª SÃ©rie": "NÃºmero de MatrÃ­culas do Ensino MÃ©dio - Modalidade Normal/MagistÃ©rio - 4Âº ano/4Âª SÃ©rie"
                }
            }
        },
        "EJA": {
            "coluna_principal": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o de Jovens e Adultos (EJA)",
            "subetapas": {
                "Ensino Fundamental": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o de Jovens e Adultos (EJA) - Ensino Fundamental",
                "Ensino MÃ©dio": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o de Jovens e Adultos (EJA) - Ensino MÃ©dio"
            },
            "series": {
                "Ensino Fundamental": {
                    "Anos Iniciais": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o de Jovens e Adultos (EJA) - Ensino Fundamental - Anos Iniciais",
                    "Anos Finais": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o de Jovens e Adultos (EJA) - Ensino Fundamental - Anos Finais"
                }
            }
        },
        "EducaÃ§Ã£o Profissional": {
            "coluna_principal": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Profissional",
            "subetapas": {
                "TÃ©cnica": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Profissional TÃ©cnica",
                "Curso FIC": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Profissional - Curso FIC Concomitante"
            },
            "series": {
                "TÃ©cnica": {
                    "Concomitante": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Profissional TÃ©cnica - Curso TÃ©cnico Concomitante",
                    "Subsequente": "NÃºmero de MatrÃ­culas da EducaÃ§Ã£o Profissional TÃ©cnica - Curso TÃ©cnico Subsequente"
                }
            }
        }
    }
    
    return mapeamento

# Primeira seleÃ§Ã£o do DataFrame
tipo_visualizacao = "Estado"  # Valor padrÃ£o
df = estado_df  # DataFrame padrÃ£o para iniciar

# Agora crie o mapeamento de colunas usando o DataFrame inicial
mapeamento_colunas = criar_mapeamento_colunas(df)

# ======================================
# CONFIGURAÃ‡ÃƒO DA BARRA LATERAL (FILTROS)
# ======================================

st.sidebar.title("Filtros")

# SeleÃ§Ã£o do nÃ­vel de agregaÃ§Ã£o
tipo_visualizacao = st.sidebar.radio(
    "NÃ­vel de AgregaÃ§Ã£o:",
    ["Escola", "MunicÃ­pio", "Estado"]
)

# SeleÃ§Ã£o do DataFrame conforme o nÃ­vel escolhido
if tipo_visualizacao == "Escola":
    df = escolas_df
elif tipo_visualizacao == "MunicÃ­pio":
    df = municipio_df
else:
    df = estado_df

# Filtro do Ano
anos_disponiveis = sorted(df["ANO"].unique())
ano_selecionado = st.sidebar.selectbox("Ano do Censo:", anos_disponiveis)

# Filtro da DEPENDENCIA ADMINISTRATIVA
dependencias_disponiveis = sorted(df["DEPENDENCIA ADMINISTRATIVA"].unique())
dependencia_selecionada = st.sidebar.multiselect(
    "DEPENDENCIA ADMINISTRATIVA:",
    dependencias_disponiveis,
    default=dependencias_disponiveis
)

# Filtro da Etapa de Ensino
etapas_disponiveis = list(mapeamento_colunas.keys())
etapa_selecionada = st.sidebar.selectbox(
    "Etapa de Ensino:",
    etapas_disponiveis
)

# Filtro da Subetapa (varia de acordo com a etapa selecionada)
subetapas_disponiveis = list(mapeamento_colunas[etapa_selecionada]["subetapas"].keys())
subetapa_selecionada = st.sidebar.selectbox(
    "Subetapa:",
    ["Todas"] + subetapas_disponiveis
)

# Filtro para a SÃ©rie, se aplicÃ¡vel Ã  subetapa selecionada
series_disponiveis = []
if subetapa_selecionada != "Todas" and subetapa_selecionada in mapeamento_colunas[etapa_selecionada]["series"]:
    series_disponiveis = list(mapeamento_colunas[etapa_selecionada]["series"][subetapa_selecionada].keys())
    serie_selecionada = st.sidebar.selectbox(
        "SÃ©rie:",
        ["Todas"] + series_disponiveis
    )
else:
    serie_selecionada = "Todas"

# -------------------------------
# AplicaÃ§Ã£o dos Filtros nos Dados
# -------------------------------
df_filtrado = df[df["ANO"] == ano_selecionado]

if dependencia_selecionada:
    df_filtrado = df_filtrado[df_filtrado["DEPENDENCIA ADMINISTRATIVA"].isin(dependencia_selecionada)]

# Determinar a coluna de dados com base na etapa, subetapa e sÃ©rie selecionadas
if subetapa_selecionada == "Todas":
    coluna_dados = mapeamento_colunas[etapa_selecionada]["coluna_principal"]
elif serie_selecionada == "Todas" or subetapa_selecionada not in mapeamento_colunas[etapa_selecionada]["series"]:
    coluna_dados = mapeamento_colunas[etapa_selecionada]["subetapas"][subetapa_selecionada]
else:
    if serie_selecionada in mapeamento_colunas[etapa_selecionada]["series"][subetapa_selecionada]:
        coluna_dados = mapeamento_colunas[etapa_selecionada]["series"][subetapa_selecionada][serie_selecionada]
    else:
        coluna_dados = mapeamento_colunas[etapa_selecionada]["subetapas"][subetapa_selecionada]

# -------------------------------
# CabeÃ§alho e InformaÃ§Ãµes Iniciais do Dashboard
# -------------------------------
st.title("Dashboard de MatrÃ­culas - Inep")
st.markdown(f"**VisualizaÃ§Ã£o por {tipo_visualizacao} - Ano: {ano_selecionado}**")

# ExibiÃ§Ã£o dos filtros selecionados
filtro_texto = f"**Etapa:** {etapa_selecionada}"
if subetapa_selecionada != "Todas":
    filtro_texto += f" | **Subetapa:** {subetapa_selecionada}"
    if serie_selecionada != "Todas" and serie_selecionada in series_disponiveis:
        filtro_texto += f" | **SÃ©rie:** {serie_selecionada}"
st.markdown(filtro_texto)

# Verifica se a coluna de dados existe; se nÃ£o, usa a coluna principal
if coluna_dados not in df_filtrado.columns:
    st.warning(f"A coluna {coluna_dados} nÃ£o estÃ¡ disponÃ­vel nos dados.")
    coluna_dados = mapeamento_colunas[etapa_selecionada]["coluna_principal"]
    if coluna_dados not in df_filtrado.columns:
        st.error("NÃ£o foi possÃ­vel encontrar dados para a etapa selecionada.")
        st.stop()

# -------------------------------
# SeÃ§Ã£o de Indicadores (KPIs)
# -------------------------------
col1, col2, col3 = st.columns(3)

# KPI 1: Total de MatrÃ­culas na etapa/subetapa/sÃ©rie selecionada
total_matriculas = df_filtrado[coluna_dados].sum()
with col1:
    st.metric("Total de MatrÃ­culas", formatar_numero(total_matriculas))

# KPI 2: MÃ©dia de MatrÃ­culas
with col2:
    if tipo_visualizacao == "Escola":
        if len(df_filtrado) > 0:
            media_por_escola = df_filtrado[coluna_dados].mean()
            st.metric("MÃ©dia de MatrÃ­culas por Escola", formatar_numero(media_por_escola))
        else:
            st.metric("MÃ©dia de MatrÃ­culas por Escola", "-")
    else:
        media_por_dependencia = df_filtrado.groupby("DEPENDENCIA ADMINISTRATIVA")[coluna_dados].mean()
        if not media_por_dependencia.empty:
            media_geral = media_por_dependencia.mean()
            st.metric("MÃ©dia de MatrÃ­culas", formatar_numero(media_geral))
        else:
            st.metric("MÃ©dia de MatrÃ­culas", "-")

# KPI 3: Indicador adicional conforme a visualizaÃ§Ã£o
with col3:
    if tipo_visualizacao == "Escola":
        total_escolas = len(df_filtrado)
        st.metric("Total de Escolas", formatar_numero(total_escolas))
    elif tipo_visualizacao == "MunicÃ­pio":
        total_municipios = len(df_filtrado)
        st.metric("Total de MunicÃ­pios", formatar_numero(total_municipios))
    else:
        st.metric("MÃ¡ximo de MatrÃ­culas", formatar_numero(df_filtrado[coluna_dados].max()))

# -------------------------------
# SeÃ§Ã£o de GrÃ¡ficos
# -------------------------------
st.markdown("## AnÃ¡lise GrÃ¡fica")

# GrÃ¡fico 1: DistribuiÃ§Ã£o de MatrÃ­culas por DEPENDENCIA ADMINISTRATIVA (GrÃ¡fico de Pizza)
fig1 = px.pie(
    df_filtrado, 
    names="DEPENDENCIA ADMINISTRATIVA", 
    values=coluna_dados,
    title="DistribuiÃ§Ã£o de MatrÃ­culas por DEPENDENCIA ADMINISTRATIVA",
    color_discrete_sequence=px.colors.qualitative.Set3
)
st.plotly_chart(fig1, use_container_width=True)

# GrÃ¡fico 2: Varia conforme o nÃ­vel de visualizaÃ§Ã£o
if tipo_visualizacao == "Estado":
    # Para visualizaÃ§Ã£o estadual, comparar matrÃ­culas entre diferentes anos
    anos_df = df[df["DEPENDENCIA ADMINISTRATIVA"].isin(dependencia_selecionada)]
    dados_anos = []
    for ano in anos_disponiveis:
        ano_data = anos_df[anos_df["ANO"] == ano]
        if not ano_data.empty and coluna_dados in ano_data.columns:
            dados_anos.append({
                "Ano": ano,
                "MatrÃ­culas": ano_data[coluna_dados].sum()
            })
    if dados_anos:
        anos_chart_df = pd.DataFrame(dados_anos)
        fig2 = px.line(
            anos_chart_df, 
            x="Ano", 
            y="MatrÃ­culas", 
            title="EvoluÃ§Ã£o de MatrÃ­culas ao Longo dos Anos",
            markers=True
        )
        st.plotly_chart(fig2, use_container_width=True)
    
elif tipo_visualizacao == "MunicÃ­pio":
    # Para visualizaÃ§Ã£o municipal, mostrar os 10 municÃ­pios com maior nÃºmero de matrÃ­culas
    top_municipios = df_filtrado.nlargest(10, coluna_dados)
    if not top_municipios.empty:
        fig2 = px.bar(
            top_municipios, 
            x="NOME DO MUNICIPIO", 
            y=coluna_dados,
            title="Top 10 MunicÃ­pios por NÃºmero de MatrÃ­culas",
            color_discrete_sequence=px.colors.qualitative.Set2
        )
        st.plotly_chart(fig2, use_container_width=True)
        
else:  # VisualizaÃ§Ã£o por Escola
    top_escolas = df_filtrado.nlargest(10, coluna_dados)
    if not top_escolas.empty:
        # Gerar nomes curtos para facilitar a visualizaÃ§Ã£o no grÃ¡fico
        top_escolas["Nome Curto"] = top_escolas["NOME DA ESCOLA"].apply(
            lambda x: x[:30] + "..." if len(x) > 30 else x
        )
        fig2 = px.bar(
            top_escolas, 
            x="Nome Curto", 
            y=coluna_dados,
            title="Top 10 Escolas por NÃºmero de MatrÃ­culas",
            color_discrete_sequence=px.colors.qualitative.Set1
        )
        fig2.update_xaxes(tickangle=45)
        st.plotly_chart(fig2, use_container_width=True)

# -------------------------------
# SeÃ§Ã£o de Tabela de Dados Detalhados
# -------------------------------
st.markdown("## Dados Detalhados")

# SeleÃ§Ã£o das colunas a serem exibidas na tabela, conforme o nÃ­vel de visualizaÃ§Ã£o
if tipo_visualizacao == "Escola":
    colunas_tabela = ["NOME DA ESCOLA", "DEPENDENCIA ADMINISTRATIVA", "NOME DO MUNICIPIO"]
elif tipo_visualizacao == "MunicÃ­pio":
    colunas_tabela = ["NOME DO MUNICIPIO", "DEPENDENCIA ADMINISTRATIVA"]
else:  # Estado
    colunas_tabela = ["NOME DA UF", "DEPENDENCIA ADMINISTRATIVA"]

# Adiciona a coluna de dados selecionada ao final
colunas_tabela.append(coluna_dados)

# Verifica se todas as colunas estÃ£o presentes no DataFrame filtrado
colunas_existentes = [col for col in colunas_tabela if col in df_filtrado.columns]
if set(colunas_existentes) != set(colunas_tabela):
    st.warning(f"Algumas colunas nÃ£o estÃ£o disponÃ­veis para exibiÃ§Ã£o na tabela: {set(colunas_tabela) - set(colunas_existentes)}")
    colunas_tabela = colunas_existentes

# Converter a coluna de dados para numÃ©rico para ordenaÃ§Ã£o correta
df_filtrado_tabela = df_filtrado.copy()
if coluna_dados in df_filtrado_tabela.columns:
    df_filtrado_tabela[coluna_dados] = pd.to_numeric(df_filtrado_tabela[coluna_dados], errors='coerce')
    tabela_dados = df_filtrado_tabela[colunas_tabela].sort_values(by=coluna_dados, ascending=False)
else:
    tabela_dados = df_filtrado_tabela[colunas_existentes]

st.dataframe(tabela_dados, use_container_width=True)

# -------------------------------
# RodapÃ© do Dashboard
# -------------------------------
st.markdown("---")
st.markdown("**Nota:** Os dados sÃ£o provenientes do Censo Escolar. Os traÃ§os (-) indicam ausÃªncia de dados.")
